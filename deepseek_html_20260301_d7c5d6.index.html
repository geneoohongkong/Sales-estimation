<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>funnel ¬∑ 4‚Äëup linked (FIXED)</title>
    <style>
        * { box-sizing: border-box; margin: 0; font-family: system-ui, -apple-system, 'Segoe UI', sans-serif; }
        body { background: #f0f3f8; padding: 2rem 1rem; }
        .container { max-width: 1500px; margin: 0 auto; }
        h2 { margin-bottom: 1.5rem; font-weight: 500; color: #1e2f4a; font-size: 1.4rem; }
        .row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .card { background: white; border-radius: 20px; padding: 1rem 0.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.02); border: 1px solid #dbe4ed; }
        .card h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.3rem; background: #ecf2f9; display: inline-block; padding: 0.1rem 1rem; border-radius: 30px; }
        .big-sales { font-size: 1.4rem; font-weight: 700; text-align: right; border-bottom: 1px solid #d2deec; padding-bottom: 0.2rem; margin-bottom: 0.6rem; color: #002856; }
        .line { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; border-bottom: 1px dashed #e2e9f2; padding: 0.2rem 0; }
        .label { color: #2b4a6f; }
        input { width: 70px; padding: 0.2rem 0.3rem; border: 1px solid #b9cbdf; border-radius: 30px; text-align: right; font-weight: 500; background: #f6faff; font-size: 0.85rem; }
        input:focus { outline: 2px solid #2b6c9e; }
        .tail-block { background: #f4f9ff; border-radius: 16px; padding: 0.5rem 0.6rem; margin: 0.7rem 0 0.3rem; }
        .tail-title { font-weight: 600; font-size: 0.7rem; text-transform: uppercase; color: #1f5090; margin-bottom: 0.2rem; }
        .readonly-sales { background: #e5ecf5; border: 1px solid #b0c6dd; font-weight: 700; width: 100px; }
        .overall { background: #102a41; color: white; border-radius: 40px; padding: 1.5rem 1.8rem; display: flex; flex-wrap: wrap; gap: 1.5rem 2rem; margin: 1.5rem 0 1rem; }
        .overall-item { display: flex; flex-direction: column; }
        .overall-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.7; }
        .overall-number { font-size: 1.6rem; font-weight: 700; }
        .attribution { text-align: center; color: #4b637b; font-size: 0.75rem; margin-top: 1.8rem; }
        .debug-info { background: #ffeb3b; color: #000; padding: 10px; margin: 10px 0; display: none; }
    </style>
</head>
<body>
    <!-- Debug banner - will show if there's an error -->
    <div id="debugBanner" style="background: #ff4444; color: white; padding: 10px; text-align: center; font-weight: bold; display: none;">
        ‚ö†Ô∏è JavaScript error detected - check console (F12)
    </div>

    <div class="container">
        <h2>‚ö° funnel ¬∑ 4‚Äëup linked (FIXED - should work now)</h2>
        
        <!-- Cards will be injected here by JavaScript -->
        <div class="row" id="cardRow">
            <!-- Loading placeholder - will be replaced -->
            <div style="grid-column: span 4; text-align: center; padding: 2rem; color: #666;">
                Loading calculator...
            </div>
        </div>

        <div class="overall">
            <div class="overall-item"><span class="overall-label">Self activation %</span><span class="overall-number" id="actPct">0.00%</span></div>
            <div class="overall-item"><span class="overall-label">Tail book sum</span><span class="overall-number" id="tailSum">0.00</span></div>
            <div class="overall-item"><span class="overall-label">Total sign no.</span><span class="overall-number" id="totalSign">0.00</span></div>
            <div class="overall-item"><span class="overall-label">Total sales</span><span class="overall-number" id="totalSales">0</span></div>
        </div>

        <div style="background: white; border-radius: 40px; padding: 0.8rem 1.8rem; display: flex; gap: 2rem; border:1px solid #d7e2ef;">
            <span>üìä tail: <span id="sumTailFoot">0.00</span></span>
            <span>üìà sign: <span id="sumSignFoot">0.00</span></span>
            <span>üí∞ sales: <span id="sumSalesFoot">0</span></span>
        </div>
        <div class="attribution">all inputs linked ¬∑ change any number ‚Üí everything recomputes</div>
    </div>

    <script>
        // Global error handler to catch and display errors
        window.onerror = function(msg, url, line, col, error) {
            const banner = document.getElementById('debugBanner');
            if (banner) {
                banner.style.display = 'block';
                banner.innerHTML = '‚ö†Ô∏è Error: ' + msg + ' at line ' + line;
            }
            console.error('JavaScript Error:', msg, 'at line', line);
            return false;
        };

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // ----- initial data -----
                const channels = [
                    { name:'Therapist',  aud:3640, reach:70, self:70, node:70, show:30, sign:30, tail:900, repl:20, tshow:30, tsign:20, sales:6856896 },
                    { name:'CSE',        aud:2000, reach:70, self:90, node:90, show:30, sign:30, tail:630, repl:20, tshow:30, tsign:20, sales:4838400 },
                    { name:'Call centre',aud:2200, reach:20, self:20, node:20, show:30, sign:30, tail:0,   repl:0,  tshow:0,  tsign:0,  sales:295680 },
                    { name:'AI agent',   aud:100000, reach:10, self:10, node:10, show:70, sign:30, tail:500, repl:20, tshow:30, tsign:20, sales:3840000 }
                ];

                // ----- build four cards -----
                const row = document.getElementById('cardRow');
                if (!row) throw new Error('Card row element not found');
                
                let html = '';
                channels.forEach((ch, i) => {
                    html += `
                    <div class="card">
                        <h3>${ch.name}</h3>
                        <div class="big-sales"><input type="number" id="s${i}" value="${ch.sales}" step="any" readonly class="readonly-sales" style="width:110px;"></div>
                        <div class="line"><span class="label">Audience</span> <input type="number" id="a${i}" value="${ch.aud}" step="1" min="0"></div>
                        <div class="line"><span class="label">Reach %</span> <input type="number" id="r${i}" value="${ch.reach}" step="any" min="0" max="100"></div>
                        <div class="line"><span class="label">Self act %</span> <input type="number" id="se${i}" value="${ch.self}" step="any" min="0" max="100"></div>
                        <div class="line"><span class="label">Node act %</span> <input type="number" id="n${i}" value="${ch.node}" step="any" min="0" max="100"></div>
                        <div class="line"><span class="label">Show %</span> <input type="number" id="sh${i}" value="${ch.show}" step="any" min="0" max="100"></div>
                        <div class="line"><span class="label">Sign %</span> <input type="number" id="si${i}" value="${ch.sign}" step="any" min="0" max="100"></div>
                        <div class="tail-block">
                            <div class="tail-title">TAIL REPLICATION</div>
                            <div class="line"><span class="label">Tail book #</span> <input type="number" id="t${i}" value="${ch.tail}" step="any" min="0"></div>
                            <div class="line"><span class="label">Repl no.</span> <input type="number" id="rep${i}" value="${ch.repl}" step="any" min="0"></div>
                            <div class="line"><span class="label">Show tail %</span> <input type="number" id="ts${i}" value="${ch.tshow}" step="any" min="0" max="100"></div>
                            <div class="line"><span class="label">Sign tail %</span> <input type="number" id="tss${i}" value="${ch.tsign}" step="any" min="0" max="100"></div>
                        </div>
                    </div>`;
                });
                row.innerHTML = html;

                // ----- helper to read input safely -----
                function getVal(id) {
                    const el = document.getElementById(id);
                    if (!el) return 0;
                    const v = parseFloat(el.value);
                    return isNaN(v) ? 0 : v;
                }

                // ----- pre‚Äëcompute ticket factors -----
                const ticketFactor = channels.map((ch, i) => {
                    const reach = ch.aud * (ch.reach/100);
                    const nodeAct = reach * (ch.node/100);
                    const shows = nodeAct * (ch.show/100);
                    const primSign = shows * (ch.sign/100);
                    const tailSign = ch.tail * ch.repl * (ch.tshow/100) * (ch.tsign/100);
                    const totalSign = primSign + tailSign;
                    return totalSign > 0 ? ch.sales / totalSign : 0;
                });

                // ----- main update function -----
                function refresh() {
                    try {
                        let totalTail = 0, totalSignNo = 0, totalSales = 0;
                        let totalSelfAct = 0, totalReached = 0;

                        for (let i = 0; i < 4; i++) {
                            // read all values
                            const aud = getVal(`a${i}`), 
                                  reach = getVal(`r${i}`)/100, 
                                  selfPct = getVal(`se${i}`)/100,
                                  nodePct = getVal(`n${i}`)/100, 
                                  showPct = getVal(`sh${i}`)/100, 
                                  signPct = getVal(`si${i}`)/100,
                                  tailBook = getVal(`t${i}`), 
                                  replNo = getVal(`rep${i}`),
                                  tailShow = getVal(`ts${i}`)/100, 
                                  tailSign = getVal(`tss${i}`)/100;

                            const reached = aud * reach;
                            const selfAct = reached * selfPct;
                            const nodeAct = reached * nodePct;
                            const shows = nodeAct * showPct;
                            const primarySign = shows * signPct;
                            const tailGenerated = tailBook * replNo * tailShow * tailSign;
                            const totalSign = primarySign + tailGenerated;
                            const sales = totalSign * ticketFactor[i];

                            totalReached += reached;
                            totalSelfAct += selfAct;
                            totalTail += tailBook;
                            totalSignNo += totalSign;
                            totalSales += sales;

                            // update readonly sales field
                            const salesField = document.getElementById(`s${i}`);
                            if (salesField) salesField.value = Math.round(sales);
                        }

                        // overall self activation %
                        const overallAct = totalReached > 0 ? (totalSelfAct / totalReached) * 100 : 0;
                        
                        // Update all display elements with null checks
                        const actPctEl = document.getElementById('actPct');
                        if (actPctEl) actPctEl.innerText = overallAct.toFixed(2) + '%';
                        
                        const tailSumEl = document.getElementById('tailSum');
                        if (tailSumEl) tailSumEl.innerText = totalTail.toFixed(2);
                        
                        const totalSignEl = document.getElementById('totalSign');
                        if (totalSignEl) totalSignEl.innerText = totalSignNo.toFixed(2);
                        
                        const totalSalesEl = document.getElementById('totalSales');
                        if (totalSalesEl) totalSalesEl.innerText = Math.round(totalSales).toLocaleString();

                        // footer
                        const sumTailFootEl = document.getElementById('sumTailFoot');
                        if (sumTailFootEl) sumTailFootEl.innerText = totalTail.toFixed(2);
                        
                        const sumSignFootEl = document.getElementById('sumSignFoot');
                        if (sumSignFootEl) sumSignFootEl.innerText = totalSignNo.toFixed(2);
                        
                        const sumSalesFootEl = document.getElementById('sumSalesFoot');
                        if (sumSalesFootEl) sumSalesFootEl.innerText = Math.round(totalSales).toLocaleString();
                    } catch (e) {
                        console.error('Refresh function error:', e);
                        document.getElementById('debugBanner').style.display = 'block';
                        document.getElementById('debugBanner').innerHTML = '‚ö†Ô∏è Calculation error: ' + e.message;
                    }
                }

                // ----- bind all inputs (except readonly sales) -----
                // Small delay to ensure all DOM elements are ready
                setTimeout(function() {
                    try {
                        const inputs = document.querySelectorAll('input:not([readonly])');
                        if (inputs.length === 0) {
                            throw new Error('No input elements found');
                        }
                        inputs.forEach(inp => inp.addEventListener('input', refresh));
                        
                        // initial update
                        refresh();
                        
                        // Hide loading placeholder
                        console.log('Calculator initialized successfully with', inputs.length, 'inputs');
                    } catch (e) {
                        console.error('Input binding error:', e);
                        document.getElementById('debugBanner').style.display = 'block';
                        document.getElementById('debugBanner').innerHTML = '‚ö†Ô∏è Input binding error: ' + e.message;
                    }
                }, 100);

            } catch (e) {
                console.error('Initialization error:', e);
                document.getElementById('debugBanner').style.display = 'block';
                document.getElementById('debugBanner').innerHTML = '‚ö†Ô∏è Initialization error: ' + e.message;
            }
        });
    </script>
</body>
</html>
